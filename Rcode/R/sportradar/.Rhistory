points_round <- data.frame(index = 1:625)
for( i in 5:37){
year     <- "16"
week   <- as.character(i)
sheet  <- paste0("FPL",year,"-GW",week,".csv")
path   <- paste0(folder,sheet)
data_temp   <- read.csv(path)
data_temp <- data_temp %>% mutate(
Surname_1   = if_else(grepl(Surname,pattern = " "),sub('.* ', '', Surname),Surname),
FirstName_1 = if_else(grepl(Surname,pattern = " "),sub(' .*', '',Surname ), FirstName)
)
data_temp <- full_join(data_temp,players,by = c("FirstName_1" = "FirstName_1","Surname_1"="Surname_1"))
data_temp <- data_temp[!is.na(data_temp$index),]
data_temp <- data_temp %>% select(index,PointsLastRound) %>% arrange(index)
points_round <- cbind(points_round,data_temp$PointsLastRound)
colnames(points_round)[i-3] <- paste0("round_",i)
}
#Opponents
opponent_round <- data.frame(index = 1:625)
for( i in 5:37){
year     <- "16"
week   <- as.character(i)
sheet  <- paste0("FPL",year,"-GW",week,".csv")
path   <- paste0(folder,sheet)
data_temp   <- read.csv(path)
data_temp <- data_temp %>% mutate(
Surname_1   = if_else(grepl(Surname,pattern = " "),sub('.* ', '', Surname),Surname),
FirstName_1 = if_else(grepl(Surname,pattern = " "),sub(' .*', '',Surname ), FirstName)
)
data_temp <- full_join(data_temp,players,by = c("FirstName_1" = "FirstName_1","Surname_1"="Surname_1"))
data_temp <- data_temp[!is.na(data_temp$index),]
data_temp <- data_temp %>% select(index,NextFixture1) %>% arrange(index)
opponent_round <- cbind(opponent_round,data_temp$NextFixture1)
colnames(opponent_round)[i-3] <- paste0("round_",i+1)
}
#Cost
cost_round <- data.frame(index = 1:625)
for( i in 5:37){
year     <- "16"
week   <- as.character(i)
sheet  <- paste0("FPL",year,"-GW",week,".csv")
path   <- paste0(folder,sheet)
data_temp   <- read.csv(path)
data_temp <- data_temp %>% mutate(
Surname_1   = if_else(grepl(Surname,pattern = " "),sub('.* ', '', Surname),Surname),
FirstName_1 = if_else(grepl(Surname,pattern = " "),sub(' .*', '',Surname ), FirstName)
)
data_temp <- full_join(data_temp,players,by = c("FirstName_1" = "FirstName_1","Surname_1"="Surname_1"))
data_temp <- data_temp[!is.na(data_temp$index),]
data_temp <- data_temp %>% select(index,Cost) %>% arrange(index)
cost_round <- cbind(cost_round,data_temp$Cost)
colnames(cost_round)[i-3] <- paste0("round_",i)
}
#Team
team_round <- data.frame(index = 1:625)
for( i in 5:37){
year     <- "16"
week   <- as.character(i)
sheet  <- paste0("FPL",year,"-GW",week,".csv")
path   <- paste0(folder,sheet)
data_temp   <- read.csv(path)
data_temp <- data_temp %>% mutate(
Surname_1   = if_else(grepl(Surname,pattern = " "),sub('.* ', '', Surname),Surname),
FirstName_1 = if_else(grepl(Surname,pattern = " "),sub(' .*', '',Surname ), FirstName)
)
data_temp <- full_join(data_temp,players,by = c("FirstName_1" = "FirstName_1","Surname_1"="Surname_1"))
data_temp <- data_temp[!is.na(data_temp$index),]
data_temp <- data_temp %>% select(index,Team.x) %>% arrange(index)
team_round <- cbind(team_round,data_temp$Team.x)
colnames(team_round)[i-3] <- paste0("round_",i)
}
#Position
pos_round <- data.frame(index = 1:625)
for( i in 5:37){
year     <- "16"
week   <- as.character(i)
sheet  <- paste0("FPL",year,"-GW",week,".csv")
path   <- paste0(folder,sheet)
data_temp   <- read.csv(path)
data_temp <- data_temp %>% mutate(
Surname_1   = if_else(grepl(Surname,pattern = " "),sub('.* ', '', Surname),Surname),
FirstName_1 = if_else(grepl(Surname,pattern = " "),sub(' .*', '',Surname ), FirstName)
)
data_temp <- full_join(data_temp,players,by = c("FirstName_1" = "FirstName_1","Surname_1"="Surname_1"))
data_temp <- data_temp[!is.na(data_temp$index),]
data_temp <- data_temp %>% select(index,PositionsList.x) %>% arrange(index)
pos_round <- cbind(pos_round,data_temp$PositionsList.x)
colnames(pos_round)[i-3] <- paste0("round_",i)
}
#Transfers in
trans_in_round <- data.frame(index = 1:625)
for( i in 5:37){
year     <- "16"
week   <- as.character(i)
sheet  <- paste0("FPL",year,"-GW",week,".csv")
path   <- paste0(folder,sheet)
data_temp   <- read.csv(path)
data_temp <- data_temp %>% mutate(
Surname_1   = if_else(grepl(Surname,pattern = " "),sub('.* ', '', Surname),Surname),
FirstName_1 = if_else(grepl(Surname,pattern = " "),sub(' .*', '',Surname ), FirstName)
)
data_temp <- full_join(data_temp,players,by = c("FirstName_1" = "FirstName_1","Surname_1"="Surname_1"))
data_temp <- data_temp[!is.na(data_temp$index),]
data_temp <- data_temp %>% select(index,TransfersInRound) %>% arrange(index)
trans_in_round <- cbind(trans_in_round,data_temp$TransfersInRound)
colnames(trans_in_round)[i-3] <- paste0("round_",i)
}
#Transfers out
trans_out_round <- data.frame(index = 1:625)
for( i in 5:37){
year     <- "16"
week   <- as.character(i)
sheet  <- paste0("FPL",year,"-GW",week,".csv")
path   <- paste0(folder,sheet)
data_temp   <- read.csv(path)
data_temp <- data_temp %>% mutate(
Surname_1   = if_else(grepl(Surname,pattern = " "),sub('.* ', '', Surname),Surname),
FirstName_1 = if_else(grepl(Surname,pattern = " "),sub(' .*', '',Surname ), FirstName)
)
data_temp <- full_join(data_temp,players,by = c("FirstName_1" = "FirstName_1","Surname_1"="Surname_1"))
data_temp <- data_temp[!is.na(data_temp$index),]
data_temp <- data_temp %>% select(index,TransfersOutRound) %>% arrange(index)
trans_out_round <- cbind(trans_out_round,data_temp$TransfersOutRound)
colnames(trans_out_round)[i-3] <- paste0("round_",i)
}
rm(list = c("data_26","data_temp"))
k <- 3
upper_lim <- 34-(k-1)
#points
for (i in seq(from = 2,by = k, to = upper_lim)) {
points_round_temp <- data.frame(index = 1:625)
points_round_temp[,2:(k+1)] <- points_round[,i:(i+(k-1))]
colnames(points_round_temp)[2:(k)] <- paste0("prev_",(k-1):1)
colnames(points_round_temp)[(k+1)] <- "realized"
if(i == 2){
points_round_k <- points_round_temp
} else{
points_round_k    <- rbind(points_round_k,points_round_temp)
}
}
#Opponents
for (i in seq(from = 2,by = k, to = upper_lim)) {
opponent_round_temp <- data.frame(index = 1:625)
opponent_round_temp[,2] <- opponent_round[,(i)]
colnames(opponent_round_temp)[2] <- "opponent"
if(i == 2){
opponent_round_k <- opponent_round_temp
} else{
opponent_round_k    <- rbind(opponent_round_k,opponent_round_temp)
}
}
opponent_round_k <- opponent_round_k %>% select(opponent)
#Team
for (i in seq(from = 2,by = k, to = upper_lim)) {
team_round_temp <- data.frame(index = 1:625)
team_round_temp[,2] <- team_round[,(i)]
colnames(team_round_temp)[2] <- "team"
if(i == 2){
team_round_k <- team_round_temp
} else{
team_round_k    <- rbind(team_round_k,team_round_temp)
}
}
team_round_k <- team_round_k %>% select(team)
#Cost
for (i in seq(from = 2,by = k, to = upper_lim)) {
cost_round_temp <- data.frame(index = 1:625)
cost_round_temp[,2] <- cost_round[,(i)]
colnames(cost_round_temp)[2] <- "cost"
if(i == 2){
cost_round_k <- cost_round_temp
} else{
cost_round_k    <- rbind(cost_round_k,cost_round_temp)
}
}
cost_round_k <- cost_round_k %>% select(cost)
#Pos
for (i in seq(from = 2,by = k, to = upper_lim)) {
pos_round_temp <- data.frame(index = 1:625)
pos_round_temp[,2] <- pos_round[,(i)]
colnames(pos_round_temp)[2] <- "pos"
if(i == 2){
pos_round_k <- pos_round_temp
} else{
pos_round_k    <- rbind(pos_round_k,pos_round_temp)
}
}
pos_round_k <- pos_round_k %>% select(pos)
#Transfers in
for (i in seq(from = 2,by = k, to = upper_lim)) {
trans_in_round_temp <- data.frame(index = 1:625)
trans_in_round_temp[,2:(k+1)] <- trans_in_round[,i:(i+(k-1))]
colnames(trans_in_round_temp)[2:(k)] <- paste0("trans_in_prev_",(k-1):1)
colnames(trans_in_round_temp)[(k+1)] <- "realized"
if(i == 2){
trans_in_round_k <- trans_in_round_temp
} else{
trans_in_round_k    <- rbind(trans_in_round_k,trans_in_round_temp)
}
}
trans_in_round_k <- trans_in_round_k %>% select(trans_in_prev_2,trans_in_prev_1)
#Transfers out
for (i in seq(from = 2,by = k, to = upper_lim)) {
trans_out_round_temp <- data.frame(index = 1:625)
trans_out_round_temp[,2:(k+1)] <- trans_out_round[,i:(i+(k-1))]
colnames(trans_out_round_temp)[2:(k)] <- paste0("trans_out_prev_",(k-1):1)
colnames(trans_out_round_temp)[(k+1)] <- "realized"
if(i == 2){
trans_out_round_k <- trans_out_round_temp
} else{
trans_out_round_k    <- rbind(trans_out_round_k,trans_out_round_temp)
}
}
trans_out_round_k <- trans_out_round_k %>% select(trans_out_prev_2,trans_out_prev_1)
regressors <- cbind(points_round_k,opponent_round_k,team_round_k,pos_round_k,trans_in_round_k,trans_out_round_k)
regressors$index <- as.factor(regressors$index)
#Needs generalization
regressors_train <- regressors[1:6250,] %>% na.omit()
regressors_test_data  <- regressors[6251:6875,] %>% na.omit()
regressors_test_data  <- regressors_test_data %>% filter(index %in% regressors_train$index)
regressors_test  <- regressors_test_data[,names(regressors_test_data) != "realized"]
##Fit model
options(stringsAsFactors = T)
model_3 <- lm(realized ~ index + prev_2 + prev_1 + opponent + team + pos + trans_in_prev_2 +
trans_in_prev_2 + trans_out_prev_1 + trans_out_prev_2,
data = regressors_train)
summary(model_3)
model_3 <- lm(realized ~ index + prev_1,
data = regressors_train)
summary(model_3)
model_3 <- lm(realized ~ index + prev_2 + prev_1 + opponent + team + pos + trans_in_prev_2 +
trans_in_prev_2 + trans_out_prev_1 + trans_out_prev_2,
data = regressors_train)
summary(model_3)
##Predict (to find best out-of-sample fit)
predictions <- predict(object = model_3,newdata = regressors_test)
######################
# Full 2017 data import
######################
#Points
###########
#Import training data
library(tidyverse)
options(stringsAsFactors = F)
folder <- "input/"
points_round <- data.frame(index = 1:625)
for( i in 1:27){
year     <- "17"
week   <- as.character(i)
sheet  <- paste0("FPL",year,"-GW",week,".csv")
path   <- paste0(folder,sheet)
data_temp   <- read.csv(path)
data_temp <- data_temp %>% mutate(
Surname_1   = if_else(grepl(Surname,pattern = " "),sub('.* ', '', Surname),Surname),
FirstName_1 = if_else(grepl(Surname,pattern = " "),sub(' .*', '',Surname ), FirstName)
)
data_temp <- full_join(data_temp,players,by = c("FirstName_1" = "FirstName_1","Surname_1"="Surname_1"))
data_temp <- data_temp[!is.na(data_temp$index),]
data_temp <- data_temp %>% select(index,PointsLastRound) %>% arrange(index)
points_round <- cbind(points_round,data_temp$PointsLastRound)
colnames(points_round)[i+1] <- paste0("round_",i)
}
#Opponents
opponent_round <- data.frame(index = 1:625)
for( i in 0:28){
year     <- "17"
week   <- as.character(i)
sheet  <- paste0("FPL",year,"-GW",week,".csv")
path   <- paste0(folder,sheet)
data_temp   <- read.csv(path)
data_temp <- data_temp %>% mutate(
Surname_1   = if_else(grepl(Surname,pattern = " "),sub('.* ', '', Surname),Surname),
FirstName_1 = if_else(grepl(Surname,pattern = " "),sub(' .*', '',Surname ), FirstName)
)
data_temp <- full_join(data_temp,players,by = c("FirstName_1" = "FirstName_1","Surname_1"="Surname_1"))
data_temp <- data_temp[!is.na(data_temp$index),]
data_temp <- data_temp %>% select(index,NextFixture1) %>% arrange(index)
opponent_round <- cbind(opponent_round,data_temp$NextFixture1)
colnames(opponent_round)[i+2] <- paste0("round_",i+1)
}
#Cost
cost_round <- data.frame(index = 1:625)
for( i in 0:28){
year     <- "17"
week   <- as.character(i)
sheet  <- paste0("FPL",year,"-GW",week,".csv")
path   <- paste0(folder,sheet)
data_temp   <- read.csv(path)
data_temp <- data_temp %>% mutate(
Surname_1   = if_else(grepl(Surname,pattern = " "),sub('.* ', '', Surname),Surname),
FirstName_1 = if_else(grepl(Surname,pattern = " "),sub(' .*', '',Surname ), FirstName)
)
data_temp <- full_join(data_temp,players,by = c("FirstName_1" = "FirstName_1","Surname_1"="Surname_1"))
data_temp <- data_temp[!is.na(data_temp$index),]
data_temp <- data_temp %>% select(index,Cost) %>% arrange(index)
cost_round <- cbind(cost_round,data_temp$Cost)
colnames(cost_round)[i+2] <- paste0("round_",i+1)
}
#Team
team_round <- data.frame(index = 1:625)
for( i in 0:28){
year     <- "17"
week   <- as.character(i)
sheet  <- paste0("FPL",year,"-GW",week,".csv")
path   <- paste0(folder,sheet)
data_temp   <- read.csv(path)
data_temp <- data_temp %>% mutate(
Surname_1   = if_else(grepl(Surname,pattern = " "),sub('.* ', '', Surname),Surname),
FirstName_1 = if_else(grepl(Surname,pattern = " "),sub(' .*', '',Surname ), FirstName)
)
data_temp <- full_join(data_temp,players,by = c("FirstName_1" = "FirstName_1","Surname_1"="Surname_1"))
data_temp <- data_temp[!is.na(data_temp$index),]
data_temp <- data_temp %>% select(index,Team.x) %>% arrange(index)
team_round <- cbind(team_round,data_temp$Team.x)
colnames(team_round)[i+1] <- paste0("round_",i)
}
#Position
pos_round <- data.frame(index = 1:625)
for( i in 0:28){
year     <- "17"
week   <- as.character(i)
sheet  <- paste0("FPL",year,"-GW",week,".csv")
path   <- paste0(folder,sheet)
data_temp   <- read.csv(path)
data_temp <- data_temp %>% mutate(
Surname_1   = if_else(grepl(Surname,pattern = " "),sub('.* ', '', Surname),Surname),
FirstName_1 = if_else(grepl(Surname,pattern = " "),sub(' .*', '',Surname ), FirstName)
)
data_temp <- full_join(data_temp,players,by = c("FirstName_1" = "FirstName_1","Surname_1"="Surname_1"))
data_temp <- data_temp[!is.na(data_temp$index),]
data_temp <- data_temp %>% select(index,PositionsList.x) %>% arrange(index)
pos_round <- cbind(pos_round,data_temp$PositionsList.x)
colnames(pos_round)[i+2] <- paste0("round_",i+1)
}
#Transfers in
trans_in_round <- data.frame(index = 1:625)
for( i in 1:28){
year     <- "17"
week   <- as.character(i)
sheet  <- paste0("FPL",year,"-GW",week,".csv")
path   <- paste0(folder,sheet)
data_temp   <- read.csv(path)
data_temp <- data_temp %>% mutate(
Surname_1   = if_else(grepl(Surname,pattern = " "),sub('.* ', '', Surname),Surname),
FirstName_1 = if_else(grepl(Surname,pattern = " "),sub(' .*', '',Surname ), FirstName)
)
data_temp <- full_join(data_temp,players,by = c("FirstName_1" = "FirstName_1","Surname_1"="Surname_1"))
data_temp <- data_temp[!is.na(data_temp$index),]
data_temp <- data_temp %>% select(index,TransfersInRound) %>% arrange(index)
trans_in_round <- cbind(trans_in_round,data_temp$TransfersInRound)
colnames(trans_in_round)[i+1] <- paste0("round_",i)
}
#Transfers out
trans_out_round <- data.frame(index = 1:625)
for( i in 1:28){
year     <- "17"
week   <- as.character(i)
sheet  <- paste0("FPL",year,"-GW",week,".csv")
path   <- paste0(folder,sheet)
data_temp   <- read.csv(path)
data_temp <- data_temp %>% mutate(
Surname_1   = if_else(grepl(Surname,pattern = " "),sub('.* ', '', Surname),Surname),
FirstName_1 = if_else(grepl(Surname,pattern = " "),sub(' .*', '',Surname ), FirstName)
)
data_temp <- full_join(data_temp,players,by = c("FirstName_1" = "FirstName_1","Surname_1"="Surname_1"))
data_temp <- data_temp[!is.na(data_temp$index),]
data_temp <- data_temp %>% select(index,TransfersOutRound) %>% arrange(index)
trans_out_round <- cbind(trans_out_round,data_temp$TransfersOutRound)
colnames(trans_out_round)[i+1] <- paste0("round_",i)
}
rm(list = c("data_26","data_temp"))
k <- 3
matches <- 27
upper_lim <- matches-(k-1)
#points
for (i in seq(from = 2,by = k, to = upper_lim)) {
points_round_temp <- data.frame(index = 1:625)
points_round_temp[,2:(k+1)] <- points_round[,i:(i+(k-1))]
colnames(points_round_temp)[2:(k)] <- paste0("prev_",(k-1):1)
colnames(points_round_temp)[(k+1)] <- "realized"
if(i == 2){
points_round_k <- points_round_temp
} else{
points_round_k    <- rbind(points_round_k,points_round_temp)
}
}
#Opponents
for (i in seq(from = 2,by = k, to = upper_lim)) {
opponent_round_temp <- data.frame(index = 1:625)
opponent_round_temp[,2] <- opponent_round[,(i+(k-1))]
colnames(opponent_round_temp)[2] <- "opponent"
if(i == 2){
opponent_round_k <- opponent_round_temp
} else{
opponent_round_k    <- rbind(opponent_round_k,opponent_round_temp)
}
}
opponent_round_k <- opponent_round_k %>% select(opponent)
#Team
for (i in seq(from = 2,by = k, to = upper_lim)) {
team_round_temp <- data.frame(index = 1:625)
team_round_temp[,2] <- team_round[,(i)]
colnames(team_round_temp)[2] <- "team"
if(i == 2){
team_round_k <- team_round_temp
} else{
team_round_k    <- rbind(team_round_k,team_round_temp)
}
}
team_round_k <- team_round_k %>% select(team)
#Cost
for (i in seq(from = 2,by = k, to = upper_lim)) {
cost_round_temp <- data.frame(index = 1:625)
cost_round_temp[,2] <- cost_round[,(i)]
colnames(cost_round_temp)[2] <- "cost"
if(i == 2){
cost_round_k <- cost_round_temp
} else{
cost_round_k    <- rbind(cost_round_k,cost_round_temp)
}
}
cost_round_k <- cost_round_k %>% select(cost)
#Pos
for (i in seq(from = 2,by = k, to = upper_lim)) {
pos_round_temp <- data.frame(index = 1:625)
pos_round_temp[,2] <- pos_round[,(i)]
colnames(pos_round_temp)[2] <- "pos"
if(i == 2){
pos_round_k <- pos_round_temp
} else{
pos_round_k    <- rbind(pos_round_k,pos_round_temp)
}
}
pos_round_k <- pos_round_k %>% select(pos)
#Transfers in
for (i in seq(from = 2,by = k, to = upper_lim)) {
trans_in_round_temp <- data.frame(index = 1:625)
trans_in_round_temp[,2:(k+1)] <- trans_in_round[,i:(i+(k-1))]
colnames(trans_in_round_temp)[2:(k)] <- paste0("trans_in_prev_",(k-1):1)
colnames(trans_in_round_temp)[(k+1)] <- "realized"
if(i == 2){
trans_in_round_k <- trans_in_round_temp
} else{
trans_in_round_k    <- rbind(trans_in_round_k,trans_in_round_temp)
}
}
trans_in_round_k <- trans_in_round_k %>% select(trans_in_prev_2,trans_in_prev_1)
#Transfers out
for (i in seq(from = 2,by = k, to = upper_lim)) {
trans_out_round_temp <- data.frame(index = 1:625)
trans_out_round_temp[,2:(k+1)] <- trans_out_round[,i:(i+(k-1))]
colnames(trans_out_round_temp)[2:(k)] <- paste0("trans_out_prev_",(k-1):1)
colnames(trans_out_round_temp)[(k+1)] <- "realized"
if(i == 2){
trans_out_round_k <- trans_out_round_temp
} else{
trans_out_round_k    <- rbind(trans_out_round_k,trans_out_round_temp)
}
}
trans_out_round_k <- trans_out_round_k %>% select(trans_out_prev_2,trans_out_prev_1)
#################
# Create regressors DF
#################
regressors_17 <- cbind(points_round_k,opponent_round_k,team_round_k,pos_round_k,trans_in_round_k,trans_out_round_k)
regressors_17$index <- as.factor(regressors_17$index)
#Needs generalization
predictors  <- regressors_17[1:625,] %>% na.omit()
View(predictors)
predictors  <- predictors %>% filter(index %in% regressors_train$index)
predictors  <- predictors[,names(predictors) != "realized"]
##Predict
predictions <- predict(object = model_3,newdata = predictors)
#Needs generalization
predictors  <- regressors_17[1:625,] %>% na.omit()
predictors  <- predictors %>% filter(index %in% regressors_train$index) %>% filter(
opponent != c("Brighton", "Huddersfield", "Newcastle"))
View(predictors)
predictors  <- predictors %>% filter(index %in% regressors_train$index) %>% filter(
!opponent %in% c("Brighton", "Huddersfield", "Newcastle"))
View(predictors)
##Predict
predictions <- predict(object = model_3,newdata = predictors)
!team %in% c("BHA", "HUD", "NEW")) %>% filter(
predictors  <- predictors %>% filter(index %in% regressors_train$index) %>% filter(
!opponent %in% c("Brighton", "Huddersfield", "Newcastle")) %>% filter(
!team %in% c("BHA", "HUD", "NEW")
)
predictors  <- predictors[,names(predictors) != "realized"]
##Predict
predictions <- predict(object = model_3,newdata = predictors)
compare <- data.frame(pred = round(predictions), real = regressors_test_data$realized )
#Needs generalization
predictors  <- regressors_17[1:625,] %>% na.omit()
predictors  <- predictors %>% filter(index %in% regressors_train$index) %>% filter(
!opponent %in% c("Brighton", "Huddersfield", "Newcastle")) %>% filter(
!team %in% c("BHA", "HUD", "NEW")
)
realizations <- predictors$realized
predictors  <- predictors[,names(predictors) != "realized"]
##Predict
predictions <- predict(object = model_3,newdata = predictors)
compare <- data.frame(pred = round(predictions), real = regressors_test_data$realized )
predictors  <- regressors_17[1:625,] %>% na.omit()
predictors  <- predictors %>% filter(index %in% regressors_train$index) %>% filter(
!opponent %in% c("Brighton", "Huddersfield", "Newcastle")) %>% filter(
!team %in% c("BHA", "HUD", "NEW")
)
realizations <- predictors$realized
##Predict
predictions <- predict(object = model_3,newdata = predictors)
compare <- data.frame(pred = round(predictions), real = realizations )
View(compare)
